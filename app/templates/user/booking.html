{% extends "dashboard_base.html" %}
{% block title %}رزروهای من | {{ site.brand }}{% endblock %}

{% block content %}

<div class="topbar d-flex justify-content-between align-items-center">
  <h3 class="m-0">رزروهای من</h3>
  <a href="{{ url_for('main.user_dashboard') }}" class="btn btn-outline-secondary btn-sm">
    بازگشت به داشبورد
  </a>
</div>

<div class="container-fluid">

  {% if bookings %}
    <div class="card shadow-sm">
      <div class="card-body">
        <h5 class="mb-3">لیست رزروها</h5>

        <div class="table-responsive">
          <table class="table table-striped align-middle text-center">
            <thead>
              <tr>
                <th>شناسه</th>
                <th>تاریخ</th>
                <th>ساعت</th>
                <th>مدت (دقیقه)</th>
                <th>نوع</th>
                <th>لاین</th>
                <th>وضعیت</th>
                <th>عملیات</th>
              </tr>
            </thead>
            <tbody>
              {% for b in bookings %}
              <tr>
                <td>{{ b.id }}</td>
                <td>{{ b.date }}</td>
                <td>{{ b.time }}</td>
                <td>{{ b.duration }}</td>
                <td>{{ b.type }}</td>
                <td>
                  {% if b.lane %}
                    لاین {{ b.lane }}
                  {% else %}
                    -
                  {% endif %}
                </td>
                <td>
                  {% if b.status == "active" %}
                    <span class="badge bg-success">فعال</span>
                  {% elif b.status == "cancelled" %}
                    <span class="badge bg-secondary">لغوشده</span>
                  {% else %}
                    <span class="badge bg-dark">{{ b.status }}</span>
                  {% endif %}
                </td>
                <td>
                  {% if b.status == "active" %}
                    <button class="btn btn-sm btn-outline-danger"
                            onclick="cancelBooking('{{ b.id }}')">
                      لغو
                    </button>
                  {% else %}
                    -
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

      </div>
    </div>
  {% else %}
    <div class="card shadow-sm">
      <div class="card-body text-center text-muted">
        هنوز رزروی ثبت نکرده‌اید.
      </div>
    </div>
  {% endif %}

</div>

{% endblock %}

{% block scripts %}
<script>
function cancelBooking(bookingId) {
  if (!confirm("آیا از لغو این رزرو مطمئن هستید؟")) {
    return;
  }

  fetch("/api/bookings/cancel", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ booking_id: bookingId })
  })
  .then(res => res.json())
  .then(data => {
    // برای MVP ساده: فقط رفرش صفحه
    if (data.status === "success") {
      location.reload();
    } else {
      alert(data.message || "خطا در لغو رزرو");
    }
  })
  .catch(err => {
    console.error(err);
    alert("خطا در ارتباط با سرور");
  });
}
</script>
{% endblock %}
